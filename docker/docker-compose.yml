version: '3.8'

services:
  # ============================================
  # API Gateway & Reverse Proxy
  # ============================================
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: api_gateway
    restart: unless-stopped
    ports:
      - "8080:8080"
      - "8443:8443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./nginx/logs:/var/log/nginx
    networks:
      - frontend_network
      - backend_network
    depends_on:
      - api_server
      - mcp_gateway
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M

  # ============================================
  # Main API Server (FastAPI)
  # ============================================
  api_server:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: api_server
    restart: unless-stopped
    environment:
      - ENVIRONMENT=${ENVIRONMENT:?ENVIRONMENT required}
      - DATABASE_URL=${DATABASE_URL:?DATABASE_URL required}
      - REDIS_URL=${REDIS_URL:?REDIS_URL required}
      - AUTH0_DOMAIN=${AUTH0_DOMAIN:?AUTH0_DOMAIN required}
      - AUTH0_CLIENT_ID=${AUTH0_CLIENT_ID:?AUTH0_CLIENT_ID required}
      - AUTH0_CLIENT_SECRET=${AUTH0_CLIENT_SECRET:?AUTH0_CLIENT_SECRET required}
      - AUTH0_AUDIENCE=${AUTH0_AUDIENCE:?AUTH0_AUDIENCE required}
      - SECRET_KEY=${SECRET_KEY:?SECRET_KEY required}
      - MCP_GATEWAY_URL=http://mcp_gateway:8000
    volumes:
      - ./api:/app
      - api_data:/app/data
    networks:
      - backend_network
    depends_on:
      - redis
      - database
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # ============================================
  # MCP Gateway/Orchestrator
  # ============================================
  mcp_gateway:
    build:
      context: ./mcp-gateway
      dockerfile: Dockerfile
    container_name: mcp_gateway
    restart: unless-stopped
    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN:?GITHUB_TOKEN required}
      - BRAVE_API_KEY=${BRAVE_API_KEY}
      - ZAPIER_API_KEY=${ZAPIER_API_KEY}
      - APIDOG_TOKEN=${APIDOG_TOKEN}
      - APIDOG_PROJECT_ID=${APIDOG_PROJECT_ID}
      - REDIS_URL=${REDIS_URL:?REDIS_URL required}
    volumes:
      - ./mcp-gateway:/app
      - mcp_data:/app/data
    networks:
      - backend_network
      - mcp_network
    depends_on:
      - redis
      - github_mcp
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # ============================================
  # MCP Servers
  # ============================================
  github_mcp:
    image: ghcr.io/github/github-mcp-server:latest
    container_name: github_mcp_server
    restart: unless-stopped
    environment:
      - GITHUB_PERSONAL_ACCESS_TOKEN=${GITHUB_TOKEN:?GITHUB_TOKEN required}
      - GITHUB_READ_ONLY=${GITHUB_READ_ONLY:-0}
      - GITHUB_TOOLSETS=${GITHUB_TOOLSETS:-all}
    networks:
      - mcp_network
    volumes:
      - github_mcp_data:/app/data
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f github-mcp-server || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  # ============================================
  # Database (PostgreSQL - Supabase compatible)
  # ============================================
  database:
    image: postgres:16-alpine
    container_name: postgres_db
    restart: unless-stopped
    environment:
      - POSTGRES_DB=${POSTGRES_DB:?POSTGRES_DB required}
      - POSTGRES_USER=${POSTGRES_USER:?POSTGRES_USER required}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:?POSTGRES_PASSWORD required}
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/init:/docker-entrypoint-initdb.d:ro
    networks:
      - backend_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G

  # ============================================
  # Redis Cache
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: redis_cache
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD:?REDIS_PASSWORD required} --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - backend_network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  # ============================================
  # MongoDB (Optional - for document storage)
  # ============================================
  mongodb:
    image: mongo:7
    container_name: mongodb
    restart: unless-stopped
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_ROOT_USER:?MONGO_ROOT_USER required}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_ROOT_PASSWORD:?MONGO_ROOT_PASSWORD required}
      - MONGO_INITDB_DATABASE=${MONGO_DATABASE:?MONGO_DATABASE required}
    volumes:
      - mongodb_data:/data/db
      - ./database/mongodb-init:/docker-entrypoint-initdb.d:ro
    networks:
      - backend_network
    ports:
      - "127.0.0.1:27017:27017"  # Bind to localhost only
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # ============================================
  # Monitoring & Logging
  # ============================================
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=15d'
    networks:
      - monitoring_network
    ports:
      - "127.0.0.1:9090:9090"
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:?GRAFANA_PASSWORD required}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
    networks:
      - monitoring_network
    ports:
      - "127.0.0.1:3000:3000"
    depends_on:
      - prometheus
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  # ============================================
  # Secrets Management (Vault - Optional)
  # ============================================
  vault:
    image: vault:latest
    container_name: vault
    restart: unless-stopped
    cap_add:
      - IPC_LOCK
    environment:
      - VAULT_DEV_ROOT_TOKEN_ID=${VAULT_ROOT_TOKEN:?VAULT_ROOT_TOKEN required}
      - VAULT_DEV_LISTEN_ADDRESS=0.0.0.0:8200
    volumes:
      - vault_data:/vault/file
    networks:
      - backend_network
    ports:
      - "127.0.0.1:8200:8200"
    command: ["server", "-dev"]
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M

# ============================================
# Networks
# ============================================
networks:
  frontend_network:
    driver: bridge
    name: frontend_net
  backend_network:
    driver: bridge
    name: backend_net
    internal: false
  mcp_network:
    driver: bridge
    name: mcp_net
  monitoring_network:
    driver: bridge
    name: monitoring_net

# ============================================
# Volumes
# ============================================
volumes:
  postgres_data:
    driver: local
    name: postgres_data
  mongodb_data:
    driver: local
    name: mongodb_data
  redis_data:
    driver: local
    name: redis_data
  api_data:
    driver: local
    name: api_data
  mcp_data:
    driver: local
    name: mcp_data
  github_mcp_data:
    driver: local
    name: github_mcp_data
  prometheus_data:
    driver: local
    name: prometheus_data
  grafana_data:
    driver: local
    name: grafana_data
  vault_data:
    driver: local
    name: vault_data


